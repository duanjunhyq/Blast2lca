Blast2lca 0.300 (Jul 2012) README file

TUTORIAL
========

blast2lca is a fast and light implementation of the XXX algorithm (REF) to calculate the lowest common ancestor ...
It has been primarily used as part of computational pipelines in the analysis of the taxonomic content of metagenomic samples.
If you want to try blast2lca before reading the whole documentation, follow these steps:

1.- Downloads:
1.- Download:
1.1.- Blast2lca binaries (blast2lca and gitaxid2bin) from GitHub (alternatively, install Blast2lca with "go get" (see below))
1.2.- The NCBI's taxonomy database from ftp://ftp.ncbi.nih.gov/pub/taxonomy/ (in particular the following files: taxdump.tar.gz, and the gi_taxid_[prot/nucl].dmp file/s needed). Uncompress & untar taxdump.tar.gz to get the names.dmp and nodes.dmp files.

2.- Reformat the database files:
2.1.- gi_taxid_[prot/nucl].dmp :
  + cd into the directory you downloaded gi_taxid_[prot/nucl].dmp
  + run gitaxid2bin in that directory
  + a new file (gi_taxid_[prot/nucl].bin) should appear in that folder
2.2.- For functional annotations (via KEGG) you need also to reformat the file genes_ncbi-gi.list:
  + cd into the directory where the file genes_ncbi-gi.list is located
  + run kegg2bin in that directory
  + a new file (kegg.bin) should appear in that folder

3.- Run the program:
For example:
$ blast2lca -savemem -dict db/gi_taxid_prot.bin -nodes db/nodes.dmp -names db/names.dmp metagenome.blout > metagenome.lca

TITLE
=====
blast2lca: A building block for taxonomic assignment in metagenomic analyses

ABSTRACT
========
In computer science, the development of fast and reliable tools performing single tasks efficiently has been central for the development of the most successful complex systems. For example, this has been the central concept of the *nix operating systems for decades. In metagenomic, having fast algorithms performing basic steps of analysis is as important as it is in any other genomic field, where the amount of data generated by the new sequencing technologies surpases in many occasions the available capacity of analysis. Taxonomic profiling of the sequence obtained is one of these basic steps that most of the analysis pipelines of metagenomic data performs. It is not easy though, to find fast and reliable implementations of the basic algorithms used for taxonomic profiling easy integrable(?) in analysis pipelines.
 
Taxonomic profiling is a basic step on any metagenomic analysis. Its goal consists in the assignment of the sequenced reads or assembled contigs to specific taxa to further characterize the taxonomical diversity of the sample under study. Several methods have been proposed for this kind of characterization. These methods can be classified in two main categories based on their dependence to homology searches (supervised / unsupervised) (REF). Thus, the homology independent methods normally rely on intrinsic characteristics of the sequences to classify them in bins that, in a second step, are assigned to a specific taxa. Examples of these kind of methods are TETRA, etc, blah, blah. The second kind of methods rely on homology searches to derive the taxonomical classification of the query sequences based on that of the homologies obtained. This method has been used by tools like phylopythia, etc... One popular method based on homology searches consists on the determination of the lowest common ancestor (LCA) of the best homologues of a given sequence. Thus, the query sequences are searched for homologues within a comprehensive database and the taxonomical classification of those homologues are transfered to the queries. This method has been included in the MEGAN software, one of the most used tool in the metagenomic field. (QUE METODO USAN OTROS SOFTWARES?) and its popularity comes from its simplicity of concept and potentially fast algorithm.
Having fast algorithms for metagenomic analysis is as important as it is for any other genomic field. Nowadays, the 

IMPLEMENTATION
==============
blast2lca is a command-line tool designed to efficiently process blast output files 
The LCA algorithm is closely related with the RMQ problem of finding ... The LCA problem is just a special case of RMQ where ...
There has been proposed several algorithms that resolves the RMQ problem in linear time (REFS? REVIEW?) with complexity in big-O notation O(L) with L being ... Here we implement the ... algorithm described in ... This algorithm requires the pre-processing of the reference tree, but one it is processed, the RMQ and LCA searches can be computed in linear time.

blast2lca has been written in Go. A modern, multi-platform, compiled, strong typed multi-purpose programming language developed by Google that has recently reached the milestone of its first stable version (Go1) in March 2012. One of most attractive characteristics of this programming language is its support for multi-core programming from its design with primitives... These characteristics makes it an attractive language for the development of computationally intensive tasks using the built-in concurrency primitives. Thus, blast2lca is highly parallelized, with one process reading the blast input file and in parallel, potentially dozens of processes calculates the LCA of each sequence in parallel. These processes are multiplexed on the available cores of the machine. Our tests show that blast2lca is able to reach linear speedup with the number of cores in the range between 1 and 10 processes in a 4-core machine.


INTRODUCTION
============

Blast2lca is a tool designed to help in the taxonomical assignment of biological sequences through BLAST (http://www.ncbi.nlm.nih.gov/pmc/articles/PMC146917/?tool=pubmed) based homology searches. For this assignment it calculates the lowest common ancestor (LCA: http://en.wikipedia.org/wiki/Lowest_common_ancestor) of the best scoring homologs. It works in a similar way as the MEGAN tool (see below for details).

Its input is the output of the BLAST program (tab formatted with "-m8" option in blastall or "-outfmt 6" in blast+ programs). The "subject" field must contain its GI identifier in the form "gi|xxxxxxxxxx|" where "x"s are the actual identifier (this is likely to happen if you use NCBI databases like nr or nt).

You will also need the Taxonomy database from the NCBI (the taxdump.[gz|tar.gz|tar.Z] and the gi_taxid_[nucl|prot].[zip|dmp.gz] files. These files can be downloaded from ftp://ftp.ncbi.nih.gov/pub/taxonomy/. See HOW TO RUN THE PROGRAM below.

Blast2lca also allows functional mapping through KEGG annotations (SEED annotations will be added --hopefully-- soon).


A note on MEGAN:
-----------------
MEGAN (http://www-ab.informatik.uni-tuebingen.de/software/megan) is a nice tool for global analysis and taxonomic representation of metagenomic sequences but while working with it we noticed a few issues that prevent its use for our specific needs:

- Although written in Java, MEGAN is not a very fast tool, or at least, not fast enough when you are analyzing many >10e5 sequences. Working with 454-Titanium runs we noticed long hangs and crashes.

- MEGAN focuses in the global analysis of the input sequences. This means that it needs to track information of all the sequences being analyzed to show the final trees, etc. But many times we prefer to get the LCA of each individual sequence to further analyze them using different statistical methods. Unfortunately, when exporting the LCA of each individual sequence MEGAN doesn't inform you about the taxonomic rank or level the LCA is, making it hard i) to know how specific the LCA is and ii) to postprocess this LCA information (for example, group by "family" level).

- It works with the full (pairwise) output of BLAST instead of the more compacted tabular form. This means that if you are working with many sequences i) BLAST will be slower and ii) Your input to MEGAN will be orders of magnitud bigger.

- It is not obvious how to update the taxonomy information that MEGAN uses. The NCBI's Taxonomy database is dynamic and interpreting a recent BLAST result with an outdated taxonomy leads to a greater number of unassigned hits and sequences.

Some of these concerns were commented with the MEGAN development team (Dr. Huson's lab) and we are greatful for the inclusion of some of them in the MEGAN package (for example, now MEGAN is able to deal with a modified BLAST tabular format that must include an extra column with the Taxid of the subject GIs, for us this is far better than having to run all the BLAST with full/pairwise output). But finally we decided to build a tool that tackles these specific issues.

Blast2lca is:

+ Fast: It is multicore. Has been used in a 24-nodes server obtaining > 20x accelerations. We are however trying to improve the speed of each individual thread.

+ Simple: Its input is a tabular blast result (-m8) and the NCBI's taxonomy database. Its output is the sequence IDs and their LCA. There is only one aditional step: you have to reformat the gi_taxid[nucl|prot].[zip|dmp.gz] file that serves the GI to taxid mappings (available at the NCBI site (ftp://ftp.ncbi.nih.gov/pub/taxonomy/) to speed up things.

+ Transparent: Since you use the NCBI's Taxonomy database directly you can be always up-to-date with the current releases.

Of course, Blast2lca doesn't give you all the other goodies that MEGAN offers you (fancy tree visualization, etc...).


A note on Go:
-------------
Blast2lca is written in Google's Go programming language (http://golang.org/). This is a great language but still not mature. This means that code written in current Go may be broken as the language evolves and that its runtime is still not as fast and efficient as it will be. As part of the maintenance of this program I will keep this code up to date with the latest Go implementations.


INSTALLATION:
=============

It is recommended to use the binaries provided with the distribution. If you need a binary not available in this site you can ask me and I will try to build it for you. Alternatively, you can compile the program yourself.

To build the blast2lca binary you need the Go developing tools (available at http://golang.org). Remember to set the environmental variable $GOROOT as described in the GO documentation.

export GOROOT=<directory_where_you_installed_go>

Then download the Blast2lca source code from GitHub. Once you have it, uncompress and:

cd Blast2lca-xxxx
make

There is not a "make install". Blast2lca binary will be placed in the current directory.



COMMON USAGE:
=============

1.- Taxonomy DB preparation:
----------------------------
The first time you use this software (and in general everytime you want to update the Taxonomy database) you should prepare the Taxonomy database for its usage with Blast2lca. Follow these steps:

1.- Download the Taxonomy database from NCBI's site (only taxdump.tgz and gi_taxid[nucl|prot].dmp.gz are needed).

$ wget ftp://ftp.ncbi.nih.gov/pub/taxonomy/taxdump.tar.gz
$ wget ftp://ftp.ncbi.nih.gov/pub/taxonomy/gi_taxid_nucl.dmp.gz

2.- Uncompress & untar

$ tar -xzvf taxdump.tar.gz
$ gunzip gi_taxid_nucl.dmp.gz # or gi_taxid_prot.dmp.gz

3.- Convert gi_taxid_[prot|nucl].dmp to binary format:

$ perl /path/to/Blast2lca/tools/tax2bin2.pl gi_taxid_nucl.dmp > gi_taxid_nucl.bin

Were "/path/to/Blast2lca/" is the path where you have downloaded Blast2lca.

Note: In the above steps substitute "gi_taxid_nucl.dmp.gz" by "gi_taxid_prot.dmp.gz" if your blasts have been run against a protein database (nr).


2.- Run the program:
--------------------
$ ./blast2lca [options] <blast>
Where options are:

      --version:
              Prints the current version and exits

      --help:
              Prints the usage of the software and exits

      --ncpus:
              Number of CPUs to use (defaults to 4)

      --savemem:
              The data structures used by the program are stored in the hard disk
              instead of in memory. For now, this option is recommended.

      --nodes:
              Path to the nodes.dmp file downloaded from the NCBI's Taxonomy DB
              Defaults to "nodes.dmp"

      --names:
              Path to the names.dmp file downloaded from the NCBI's Taxonomy DB
              Defaults to "names.dmp"

      --bintax: [EXPERIMENTAL]
              Taxonomy in binary format (from tax2bin).

      --dict:
              Path to the gi2taxid binary file you have obtained from the previous step

      --gi2kegg:
              Path to the genes_ncbi-gi.list (from KEGG)

      --binkegg:
              genes_ncbi-gi.list in binary format (from kegg2bin)

      --levels:
             The taxonomic levels you want from the LCA.
             If the LCA of a sequence is lower than the specified level, you will get this instead.
             If the LCA of a sequence is higher than the specified level, you will get the true LCA but with the letters "uc_" preppended ("uc" stands for unclassified).
	     You can pass a series of taxonomy levels separated by ":", see the example below

Example:
$ ./blast2lca -names names.dmp -nodes nodes.dmp -dict gi_taxid_prot.bin -levels superkingdom:phylum:class:family blastm8.txt > lca.txt

3.- Output:
----------
For each input query sequence you will obtain its header and its taxons according to the LCA (separated by a tab).
Example:
GCQ6XTU01A3NBL	Bacteria;Firmicutes;Bacilli;Streptococcaceae
GCQ6XTU01A3N9G	Bacteria;Cyanobacteria;uc_Cyanobacteria;uc_Chroococcales
GCQ6XTU01A3N88	Bacteria;Proteobacteria;Gammaproteobacteria;Pasteurellaceae
GCQ6XTU01A3N8G	Bacteria;Proteobacteria;Deltaproteobacteria;Myxococcaceae
GCQ6XTU01A3NC4	Bacteria;Firmicutes;Bacilli;Streptococcaceae

As a fist global visualization of the result you can run the script makeTree.pl (under the tools/ directory) to generate a tree in HTML (+CSS +JavaScript) that can be visualized with any web browser. See the tools/makeTree.README file for (a bit) more information.

If you are using functional annotations, these will appear in the third column:
ECSKW3110|AC_000091|1250851|427	Enterobacteriaceae	
ECSKW3110|AC_000091|4553637|480	Enterobacteriaceae	ECBD_3715;
ECSKW3110|AC_000091|4572756|426	Enterobacteriaceae	EcolC_3725;
ECSKW3110|AC_000091|2573950|403	Enterobacteriaceae	ECs3324;SSON_2541;
ECSKW3110|AC_000091|1202452|391	Enterobacteriaceae	JW1128;EFER_0578;
ECSKW3110|AC_000091|1134013|472	Enterobacteriaceae	
ECSKW3110|AC_000091|911794|452	Enterobacteriaceae	
ECSKW3110|AC_000091|3730556|391	Enterobacteriaceae	APECO1_2738;
ECSKW3110|AC_000091|2766662|437	Enterobacteriaceae	b2632;b2632;
ECSKW3110|AC_000091|312368|404	Enterobacteriaceae	EcE24377A_0310;EcE24377A_0310;
ECSKW3110|AC_000091|904150|428	Enterobacteriaceae	S0861;

Functional annotations are based on the best annotated non-overlapping hits, i.e, a sequence can have more than one annotation.
For example b2632;b2632 means that 2 non-overlapping proteins with the same function have been detected in the read.

BUGS:
=====

TO-DO:
------
 + Include in one dictionary the "nucl" and "prot" versions of "gi_taxid" since the resulting dictionary will occupy the same space
 + Allow real (unfiltered) LCAs.
 + Improve the multi-thread design
 + Add other functional databases (SEED)
 + Translate functional IDs into functional descriptions
 + Web server to visualize the results
 + More tools

Known problems:
---------------
 + In 0.2 most of the code have been rewritten. LCA algorithm should be very fast now, but multi-threading design is improvable (for example, LCA for a single sequence is so fast now, that you gain no performance by processing 1 sequence per core).
 + I have to profile with real datasets and improve performance.

CONTACT:
========
For bug reports, feature requests or comments, please send an email to emepyc@gmail.com



